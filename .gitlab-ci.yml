stages:
    - build

build:php54:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/php54-fpm:$CI_COMMIT_TAG ./docker/php -f ./docker/php/Dockerfile-php54
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/php54-fpm ./docker/php -f ./docker/php/Dockerfile-php54
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/php54-fpm:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/php54-fpm
    only:
        changes:
            - docker/php/conf/*
            - docker/php/Dockerfile-php54

build:php56:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/php56-fpm:$CI_COMMIT_TAG ./docker/php -f ./docker/php/Dockerfile-php56
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/php56-fpm ./docker/php -f ./docker/php/Dockerfile-php56
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/php56-fpm:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/php56-fpm
    only:
        changes:
            - docker/php/conf/*
            - docker/php/Dockerfile-php56

build:php70:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/php70-fpm:$CI_COMMIT_TAG ./docker/php -f ./docker/php/Dockerfile-php70
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/php70-fpm ./docker/php -f ./docker/php/Dockerfile-php70
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/php70-fpm:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/php70-fpm
    only:
        changes:
            - docker/php/conf/*
            - docker/php/Dockerfile-php70

build:php71:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/php71-fpm:$CI_COMMIT_TAG ./docker/php -f ./docker/php/Dockerfile-php71
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/php71-fpm ./docker/php -f ./docker/php/Dockerfile-php71
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/php71-fpm:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/php71-fpm
    only:
        changes:
            - docker/php/conf/*
            - docker/php/Dockerfile-php71

build:php72:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/php72-fpm:$CI_COMMIT_TAG ./docker/php -f ./docker/php/Dockerfile-php72
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/php72-fpm ./docker/php -f ./docker/php/Dockerfile-php72
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/php72-fpm:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/php72-fpm
    only:
        changes:
            - docker/php/conf/*
            - docker/php/Dockerfile-php72

build:php73:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/php73-fpm:$CI_COMMIT_TAG ./docker/php -f ./docker/php/Dockerfile-php73
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/php73-fpm ./docker/php -f ./docker/php/Dockerfile-php73
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/php73-fpm:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/php73-fpm
    only:
        changes:
            - docker/php/conf/*
            - docker/php/Dockerfile-php73

build:golang111:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/golang-1-11:$CI_COMMIT_TAG ./docker/golang -f ./docker/golang/Dockerfile-golang111
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/golang-1-11:$CI_COMMIT_TAG ./docker/golang -f ./docker/golang/Dockerfile-golang111
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/golang-1-11:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/golang-1-11
    only:
        changes:
            - docker/golang/*

build:python37:
    stage: build
    image: tmaier/docker-compose:latest
    services:
        - docker:dind
    before_script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    script:
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker build -t registry.gitlab.com/contextualcode/platform_cc/python-3-7:$CI_COMMIT_TAG ./docker/python -f ./docker/python/Dockerfile-python37
            fi
            docker build -t registry.gitlab.com/contextualcode/platform_cc/python-3-7 ./docker/python -f ./docker/python/Dockerfile-python37
        - |
            if [ -z "$CI_COMMIT_TAG" ]; then
                docker push registry.gitlab.com/contextualcode/platform_cc/python-3-7:$CI_COMMIT_TAG
            fi
            docker push registry.gitlab.com/contextualcode/platform_cc/python-3-7
    only:
        changes:
            - docker/python/*