# from mla
name: app
type: php:5.6
disk: 26624
build:
    flavor: composer

variables:
    php:
        date.timezone: America/New_York
        upload_max_filesize: '256M'
        post_max_size: '256M'
        max_execution_time: '300'
        memory_limit: '512M'

    env:
        SYMFONY_ENV: 'prod'

relationships:
    database: mysqldb:mysql
    cache: memcached:memcached

web:
    commands:
        start: |
            /app/remote_syslog/remote_syslog -c /app/.remote_syslog.yml --pid-file=/app/.shared/remote_syslog.pid &&
            /usr/sbin/php5-fpm

    locations:
        /robots.txt:
            root: web
            passthru: /robots.php
        /healthcheck:
            root: web
            passthru: /healthcheck.php
        /.well-known/acme-challenge:
            root: web
            passthru: /letsencrypt_challenge.php
        /:
            root: web
            passthru: /index.php
            expires: 3600
        /docs/kalei:
            root: web
            passthru: true

mounts:
    /ezpublish/cache: shared:files/cache
    /ezpublish/logs: shared:files/logs
    /web: shared:files/web
    /ezpublish_legacy/var: shared:files/legacy_var
    /income: shared:files/income
    /.ssh: shared:files/ssh
    /.shared: shared:files

runtime:
    extensions:
        - imagick
        - xsl
        - memcached

hooks:
    build: |
        tar xfz /app/remote_syslog/remote_syslog_linux_amd64.tar.gz
        cd ezpublish_legacy
        if [ -f "extension/cc_platformsh/bin/php/init.php" ]; then
            php extension/cc_platformsh/bin/php/init.php
        fi
        cd /app
        bash platformsh/bin/bash/business_hours_check.sh

    deploy: |
        cd ezpublish_legacy
        if [ -f "bin/php/ezpgenerateautoloads.php" ]; then
            php bin/php/ezpgenerateautoloads.php -o
            php bin/php/ezpgenerateautoloads.php
        fi
        cd ../
        if [ -f "ezpublish/console" ]; then
            php ezpublish/console cache:clear
            php ezpublish/console assets:install web --symlink --relative
            php ezpublish/console assetic:dump web
            php ezpublish/console ezpublish:legacy:assets_install web --relative --symlink
        fi
        cp -R _web/* web/

crons:
    frequent:
        spec: '*/5 * * * *'
        cmd: 'php ezpublish/console ezpublish:legacy:script runcronjobs.php frequent -quiet --siteaccess site_admin'
    infrequent:
        spec: '10 0 * * *'
        cmd: 'php ezpublish/console ezpublish:legacy:script runcronjobs.php infrequent -quiet --siteaccess site_admin'
